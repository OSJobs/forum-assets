define("discourse/plugins/discourse-presence/discourse/components/topic-presence-display",["exports","@ember/component","@ember/object/computed","discourse-common/utils/decorators"],function(e,s,t,r){"use strict";function i(t,r,e,s,i){var n={};return Object.keys(s).forEach(function(e){n[e]=s[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=e.slice().reverse().reduce(function(e,s){return s(t,r,e)||e},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,r,n),n=null),n}var n,a,c;Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.extend((n=(0,r.on)("didInsertElement"),a=(0,r.on)("willDestroyElement"),i(c={topic:null,presenceManager:(0,t.readOnly)("topic.presenceManager"),users:(0,t.readOnly)("presenceManager.users"),shouldDisplay:(0,t.gt)("users.length",0),subscribe:function(){this.get("presenceManager").subscribe()},_destroyed:function(){this.get("presenceManager").unsubscribe()}},"subscribe",[n],Object.getOwnPropertyDescriptor(c,"subscribe"),c),i(c,"_destroyed",[a],Object.getOwnPropertyDescriptor(c,"_destroyed"),c),c))}),define("discourse/plugins/discourse-presence/discourse/components/composer-presence-display",["exports","@ember/component","@ember/runloop","@ember/object/computed","discourse-common/utils/decorators","../lib/presence-manager"],function(e,s,t,r,i,n){"use strict";function a(t,r,e,s,i){var n={};return Object.keys(s).forEach(function(e){n[e]=s[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=e.slice().reverse().reduce(function(e,s){return s(t,r,e)||e},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,r,n),n=null),n}var c,o,l,u,p,d,m;Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.extend((c=(0,i.on)("didInsertElement"),o=(0,i.default)("post.id","editingUsers.@each.last_seen","users.@each.last_seen"),l=(0,i.observes)("reply","title"),u=(0,i.observes)("whisper"),p=(0,i.observes)("post.id"),d=(0,i.on)("willDestroyElement"),a(m={action:null,post:null,topic:null,reply:null,title:null,isWhispering:null,presenceManager:(0,r.readOnly)("topic.presenceManager"),users:(0,r.readOnly)("presenceManager.users"),editingUsers:(0,r.readOnly)("presenceManager.editingUsers"),isReply:(0,r.equal)("action","reply"),subscribe:function(){this.presenceManager&&this.presenceManager.subscribe()},presenceUsers:function(e,s,t){return e?s.filterBy("post_id",e):t},shouldDisplay:(0,r.gt)("presenceUsers.length",0),typing:function(){if(this.presenceManager){var e=this.get("post.id");this._throttle=this.presenceManager.throttlePublish(e?n.EDITING:n.REPLYING,this.whisper,e)}},cancelThrottle:function(){this._cancelThrottle()},stopEditing:function(){this.presenceManager&&!this.get("post.id")&&this.presenceManager.publish(n.CLOSED,this.whisper)},composerClosing:function(){this.presenceManager&&(this._cancelThrottle(),this.presenceManager.publish(n.CLOSED,this.whisper))},_cancelThrottle:function(){(0,t.cancel)(this._throttle)}},"subscribe",[c],Object.getOwnPropertyDescriptor(m,"subscribe"),m),a(m,"presenceUsers",[o],Object.getOwnPropertyDescriptor(m,"presenceUsers"),m),a(m,"typing",[l],Object.getOwnPropertyDescriptor(m,"typing"),m),a(m,"cancelThrottle",[u],Object.getOwnPropertyDescriptor(m,"cancelThrottle"),m),a(m,"stopEditing",[p],Object.getOwnPropertyDescriptor(m,"stopEditing"),m),a(m,"composerClosing",[d],Object.getOwnPropertyDescriptor(m,"composerClosing"),m),m))}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/composer-fields/presence",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}}),Ember.TEMPLATES["javascripts/connectors/composer-fields/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"composer-presence-display",null,[["action","post","topic","reply","title","whisper"],[[24,["model","action"]],[24,["model","post"]],[24,["model","topic"]],[24,["model","reply"]],[24,["model","title"]],[24,["model","whisper"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/composer-fields/presence"}}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/topic-above-footer-buttons/presence",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}}),Ember.TEMPLATES["javascripts/connectors/topic-above-footer-buttons/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"topic-presence-display",null,[["topic"],[[24,["model"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/topic-above-footer-buttons/presence"}}),Ember.TEMPLATES["javascripts/components/composer-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["presenceUsers"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[0,"\\n"],[4,"if",[[24,["isReply"]]],null,{"statements":[[1,[28,"i18n",["presence.replying"],null],false]],"parameters":[]},{"statements":[[1,[28,"i18n",["presence.editing"],null],false]],"parameters":[]}],[9],[9],[7,"span",true],[10,"class","wave"],[8],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/composer-presence-display"}}),Ember.TEMPLATES["javascripts/components/topic-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["users"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[1,[28,"i18n",["presence.replying_to_topic"],[["count"],[[24,["users","length"]]]]],false],[9],[7,"span",true],[10,"class","wave"],[8],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/topic-presence-display"}}),define("discourse/plugins/discourse-presence/discourse/lib/presence-manager",["exports","@ember/object","@ember/runloop","discourse/lib/ajax","discourse-common/utils/decorators"],function(e,o,r,i,s){"use strict";var t,n;Object.defineProperty(e,"__esModule",{value:!0}),e.CLOSED=e.EDITING=e.REPLYING=void 0;var a,c,l,u,p,d,m=e.REPLYING="replying",b=e.EDITING="editing",h=e.CLOSED="closed",f=o.default.extend((t=(0,s.default)("topic.id"),a=n={users:null,editingUsers:null,subscribed:null,topic:null,currentUser:null,messageBus:null,siteSettings:null,init:function(){this._super.apply(this,arguments),this.setProperties({users:[],editingUsers:[],subscribed:!1})},subscribe:function(){var r=this;this.subscribed||(this.messageBus.subscribe(this.channel,function(e){var s=e.user,t=e.state;if(r.get("currentUser.id")!==s.id)switch(t){case m:r._appendUser(r.users,s);break;case b:r._appendUser(r.editingUsers,s,{post_id:parseInt(e.post_id,10)});break;case h:r._removeUser(s)}},0),this.set("subscribed",!0))},unsubscribe:function(){this.messageBus.unsubscribe(this.channel),this._stopTimer(),this.set("subscribed",!1)},channel:function(e){return"/presence/"+e},throttlePublish:function(e,s,t){return(0,r.throttle)(this,this.publish,e,s,t,1e4)},publish:function(e,s,t){var r={state:e,topic_id:this.get("topic.id")};return s&&(r.is_whisper=1),t&&(r.post_id=t),(0,i.ajax)("/presence/publish",{type:"POST",data:r})},_removeUser:function(t){[this.users,this.editingUsers].forEach(function(e){var s=e.findBy("id",t.id);s&&e.removeObject(s)})},_cleanUpUsers:function(){return[this.users,this.editingUsers].forEach(function(e){var s=[];e.forEach(function(e){e.last_seen<=Date.now()-12e3&&s.push(e)}),e.removeObjects(s)}),0===this.users.length&&0===this.editingUsers.length},_appendUser:function(e,s,t){var r=this,i=void 0,n=0;e.forEach(function(e){e.id===s.id&&(i=e),t&&t.post_id&&e.post_id!==t.post_id||n++});var a=t||{};if(a.last_seen=Date.now(),i)i.setProperties(a);else{var c=this.get("siteSettings.presence_max_users_shown");n<c&&e.pushObject(o.default.create(Object.assign(s,a)))}this._startTimer(function(){r._cleanUpUsers()})},_scheduleTimer:function(e){var s=this;return(0,r.later)(this,function(){e()||s.set("_timer",s._scheduleTimer(e))},2e3)},_stopTimer:function(){(0,r.cancel)(this._timer)},_startTimer:function(e){this._timer||this.set("_timer",this._scheduleTimer(e))}},c="channel",l=[t],u=Object.getOwnPropertyDescriptor(n,"channel"),p=n,d={},Object.keys(u).forEach(function(e){d[e]=u[e]}),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=l.slice().reverse().reduce(function(e,s){return s(a,c,e)||e},d),p&&void 0!==d.initializer&&(d.value=d.initializer?d.initializer.call(p):void 0,d.initializer=void 0),void 0===d.initializer&&(Object.defineProperty(a,c,d),d=null),n));e.default=f}),define("discourse/plugins/discourse-presence/initializers/discourse-presence",["exports","discourse/lib/plugin-api","../discourse/lib/presence-manager"],function(e,s,r){"use strict";function t(e){var s=e.getCurrentUser(),t=e.container.lookup("site-settings:main");s&&!s.hide_profile_and_presence&&(e.modifyClass("model:topic",{presenceManager:null}),e.modifyClass("route:topic-from-params",{setupController:function(){this._super.apply(this,arguments),this.modelFor("topic").set("presenceManager",r.default.create({topic:this.modelFor("topic"),currentUser:s,messageBus:e.container.lookup("message-bus:main"),siteSettings:t}))}}))}Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"discourse-presence",after:"message-bus",initialize:function(e){e.lookup("site-settings:main").presence_enabled&&(0,s.withPluginApi)("0.8.40",t)}}});
//# sourceMappingURL=/assets/plugins/discourse-presence-e57f36062781776a94e63805977fd5f9460cf9dabe57c7d23f482f08b2f6dc7b.js.map